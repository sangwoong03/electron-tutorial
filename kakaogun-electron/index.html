<!DOCTYPE html>
<html lang="ko">
  <head>
    <title> Kakaogun </title>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
    <link rel="stylesheet" href="main.css">
    <!-- <script src="main-renderer.js" defer></script> -->
  </head>
  <body>
    <div class="container-box">
      
      <header>
        <h2>카카오건</h2>
      </header>

      <section class="wrapper">
        
        <article class="article article--left">
          <div class="template template__text">
            <textarea type="text" class="template--box"> </textarea>
          </div>

          <div class="template template__status">
            <ul class="template--wrapper"></ul>
            <div class="text--input--wrapper">
              <input class="template_input" type="text" placeholder="템플릿명을 입력해주세요">
              <button type="submit" id="template-add" class="btn btn-primary"> 추가 </button>
            </div>
          </div>

          <div class="template option__box">
            <p class="trim-space"> 좌우공백 제거</p>
            <p class="exit-chat"> 채팅방 종료 </p>
            <p class="open-chat"> 채팅 우선열기 </p>
            <p> 지연속도 <input class="delay-time" type="number" placeholder="1s"> </p>
          </div>
        </article>
        
        <article class="article article--right">
          <div class="client client_list__box">
            <table class="table table-hover">
              <thead class="client-table__head" style="font-weight: bold">
                <tr>
                  <th scope="col">카톡이름</th>
                  <th scope="col">고객이름</th>
                  <th scope="col">발송여부</th>
                  <th scope="col">삭제</th>
                </tr>
              </thead>
              <tbody class="client-table__body"></tbody>
            </table>
          </div>
          <div class="client client--input--wrapper">
            <input class="add-client-input" type="text" placeholder="고객이름을 입력해주세요">
            <button type="submit" id="client-add" class="btn btn-primary"> 추가 </button>
          </div>
          <div id="btn--wrapper" class="d-flex justify-content-center client">
            <button type="submit" id="message-send" class="btn btn-primary btn-block"> 문자 발송 시작 </button>
          </div>
        </article>

      </section>
    </div>
    <script>
      const { activeChatMain } = require("./src/activechat.js");

      const templateArea = document.querySelector(".template--box");
      const templateBox = document.querySelector(".template--wrapper"); // status element도 가져와야함
      const templateInput = document.querySelector(".template_input");
      const templateAddBtn = document.querySelector("#template-add");

      const trimSpace = document.querySelector(".trim-space");
      const exitChat = document.querySelector(".exit-chat");
      const openChat = document.querySelector(".open-chat");
      const delayTime = document.querySelector(".delay-time");

      const clientBox = document.querySelector(".client-table__body");

      const clientKakao = document.querySelector(".client-kakao p");
      const msgStatus = document.querySelector(".message-status");
      const clientInput = document.querySelector(".add-client-input");
      const clientAddBtn = document.querySelector("#client-add");

      const sendBtn = document.querySelector("#message-send");

      // DB 내용 받아오는 것으로 변경
      let templates = [
        {
          id: 1,
          templateName: "예약 당일 확정",
          templateText: `진료 시간에 늦지 않게 방문해주세요. \n감사합니다 :) \n\n *위치 안내 \n 경기도 오산시 오산로 77 \n\n *주차안내 \n 건물 지하 주차장을 이용하실 수 있습니다.`,
        },
        {
          id: 2,
          templateName: "예약 전날 확정",
          templateText: `진료가 예정되어 있습니다. \n감사합니다 :) \n\n *위치 안내 \n 경기도 오산시 오산로 77 \n\n *주차안내 \n 건물 지하 주차장을 이용하실 수 있습니다.`,
        },
        {
          id: 3,
          templateName: "예약취소",
          templateText: `예약을 취소하셨습니다. \n감사합니다 :) \n\n *문의사항 \n 010-3770-7063`,
        },
      ];

      let clientLists = [
        {
          id: 1,
          kakao_id: "건모",
          client_name: "김건모",
        },
        {
          id: 2,
          kakao_id: "김다",
          client_name: "김다훈",
        },
        {
          id: 3,
          kakao_id: "승채",
          client_name: "백승채",
        },
      ];

      // 요소 만들기 >> ajax로 DB 통신
      function createTemplate(id, element) {
        return `<li id=${id}>
          ${element}
        </li>`;
      }

      function createClient(id, element) {
        return `<tr id=${id}>
          <td class="client-kakao"> <p contentEditable="true"> </p> </td>
          <td class="client-name"> ${element} </td> </td>
          <td class="message-status">  </td>
          <td class="delete-client"> <i id="delete-item" class="ii ii-remove"></i> </td>
        </tr>`;
      }

      // 템플릿, 고객 정보 불러오기
      function loadData() {
        // 1. 템플릿 불러오기
        templateBox.innerHTML = templates
          .map((template) => createTemplate(template.id, template.templateName))
          .join("");

        // 2. 고객 정보 불러오기
        clientBox.innerHTML = clientLists
          .map((clientList) => createClient(clientList.id, clientList.client_name))
          .join("");
      }

      // 템플릿 추가 >> ajax로 DB 통신
      function addTemplate(templateName, templateText) {
        if (templateName != "") {
          const templateObj = {
            id: templates.length + 1,
            templateName: templateName,
            templateText: templateText,
          };

          templates.push(templateObj);
          loadData();
        }
        loadTemplate();
      }

      // 유저 추가 >> ajax로 DB 통신
      function addClient(clientName) {
        // 고객이름 추가하기
        if (clientName != "") {
          const clientObj = {
            id: clientLists.length + 1,
            kakao_id: "",
            client_name: clientName,
          };

          clientLists.push(clientObj);
          loadData();
        }
      }

      // 메시지 전송
      // 다수 고객에게 보내는 경우 로직 구현하기
      function sendMessage() {
        let setDelayTime = 400;
        let clientKakaoIds = [];
        const clientNameLists = document.querySelectorAll("[contenteditable]");

        delayTime.addEventListener("input", (e) => {
          let time = e.target.value;
          time > 0 ? (setDelayTime = time * 100) : (setDelayTime = 400);
        });

        sendBtn.addEventListener("click", (e) => {
          clientNameLists.forEach((list) => clientKakaoIds.push(list.textContent));
          console.log(clientKakaoIds);
          console.log(setDelayTime);
          activeChatMain(clientKakaoIds, templateArea.value, setDelayTime);
          // activeChat(clientKakaoIds, templateArea.value, setDelayTime);
        });
      }

      function eventListener() {
        templateAddBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const tempalteName = templateInput.value;
          const templateText = templateArea.value;

          addTemplate(tempalteName, templateText);
          templateInput.value = "";
        });

        clientAddBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const clientName = clientInput.value;

          addClient(clientName);

          clientInput.value = "";
        });
      }

      loadData();
      eventListener();

      function loadTemplate() {
        const templateItems = document.querySelectorAll(".template--wrapper li");

        templateItems.forEach((templateId) => {
          templateId.addEventListener("click", (e) => {
            console.log(e.target.id);
            const templateItem = templates.filter(
              (templateItem) => templateItem.id === parseInt(e.target.id),
            );
            templateArea.innerHTML = templateItem[0].templateText;
          });
        });
      }

      loadTemplate();
      sendMessage();

    </script>
  </body>
</html>