<!DOCTYPE html>
<html lang="ko">
  <head>
    <title> Kakaogun </title>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
    <link rel="stylesheet" href="main.css">
    <!-- <script src="login-renderer.js" defer></script> -->
  </head>
<body>
  <div class="container-box">
      
    <header>
      <h2> 로그인 </h2>
    </header>
    <section class="wrapper login-wrappper">

      <form type="submit" action="#" class="login-form">
        <fieldset>
          <h3> KAKAOGUN </h3>
      
          <label for="user-id">
            <input id="user-id" class="kakao-id" type="text" placeholder="카카오 이메일">
          </label>
          <label for="user-pw">
            <input id="usre-pw" class="kakao-pw" type="password" placeholder="카카오 비밀번호">
          </label>
          <p class="error-msg" style="font-size: 12px;"> 카카오 계정 또는 비밀번호를 다시 확인해주세요 </p>
          <button id="login-btn" type="submit" class="btn btn-primary"> 로그인 </button>
        </fieldset>
      </form>

    </section>
  </div>
  <script>
    const { ipcRenderer } = require("electron");

    const { user32, KAKAO_HANDLE } = require("./src/ffi-api.js");
    const { kakaoLogin } = require("./src/login.js");

    const kakaoId = document.querySelector(".kakao-id");
    const kakaoPw = document.querySelector(".kakao-pw");
    const loginForm = document.querySelector(".login-form");
    const errorMsg = document.querySelector(".error-msg");

    // 로그인 구현
    // 카카오 이메일 / 비밀번호 받아서 로그인 확인이 되면 DB에 저장
    // 최초 hwnd 유무 확인
    // 1. hwnd === 0 >> 없음 >> 로그인해야함
    // 2. hwnd > 0 >> 있음 >> 로컬스토리지 확인 (토큰은 한명당 하나니깐)
    //    근데 로그인 안하면 DB에 안되니까 강제 로그아웃 가능? ㅇㅇ 가능 alt+n
    // 3. 로그인을 식별할 수 있는 창이 광고창인 것 같음
    //    근데 그 광고창을 식별하려면 어떤 로직이 필요할까

    // 로그인 이후
    // 1. 카톡창 생겨 윈도우 핸들이 있을 경우 ( > 0 ) 넘어가기 location.href 이거랑 ipc 통신
    // 3. 로그아웃을 했을 때 윈도우 창의 기록이 남아있어 프로그램이 실행되지 않을 수 있음
    //    설명서에 기재 필요성 :: 로그아웃 이후 로그인이 다시 안되는 경우 카카오톡 종료 후 재실행

    function login(e) {
      e.preventDefault();

      const id = kakaoId.value;
      const pw = kakaoPw.value;

      kakaoLogin(id, pw);

      setTimeout(function () {
        const IS_LOGIN = user32.FindWindowExA(KAKAO_HANDLE, 0, "BannerAdWnd", null);
        if (IS_LOGIN > 0 && id && pw) {
          location.href = "index.html";
        } else if (!id || !pw || IS_LOGIN === 0) {
          errorMsg.style.color = "red";
        }
      }, 2000);
    }

    loginForm.addEventListener("submit", login);

  </script>
</body>
</html>